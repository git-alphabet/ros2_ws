<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="MainBehaviorTree">
    
    <include path="HighHP_combat_logic.xml"/>
    <include path="MediumHP_combat_logic.xml"/>
    <include path="LowHP_combat_logic.xml"/>
    <include path="attack_right_new.xml"/>
    <include path="perception_and_blackboard.xml"/>
    <include path="IsDetectEnemy.xml"/>
    <include path="IsDeadAndDispelDebuff.xml"/>

    <BehaviorTree ID="MainBehaviorTree">
        <!-- 订阅数据并写入黑板 -->
        <SubTree ID="PerceptionAndBlackboard"/>
        <WhileDoElse>
            <IsGameTime name="IsGameStart"
                    message="{game_status}"
                    game_progress="4"
                    lower_remain_time="0"
                    higher_remain_time="300"/>
            <Fallback>
                <!--判断战亡，若战亡，执行解除虚弱状态操作 -->
                <SubTree ID="IsDeadAndDispelDebuff"/>
                <!-- 处于存活状态则进入战斗逻辑 -->
                <Fallback>
                    <!-- 检测到敌人进行战斗逻辑 -->
                    <SubTree ID="IsDetectEnemy"/>
                    <Fallback>
                        <!-- 高血量战斗逻辑 -->
                        <SubTree ID="HighHPCombatLogic"/>
                        <!-- 中血量战斗逻辑 -->
                        <SubTree ID="MediumHPCombatLogic"/>
                    </Fallback>

                    <!-- 非战斗时刻占点逻辑 -->
                    <ReactiveFallback>
                        <!-- 低血量：回补给区回血（补给区占领：每秒回 25% 上限血量） -->
                        <ReactiveSequence>
                            <IsHPBelow message="{robot_status}" hp_threshold="200"/>

                            <RateController hz="1">
                                <!-- Converted from goal_pose to goal_x/goal_y -->
                                <SendGoal name="GoSupplyToHeal"
                                        goal_x="{ally_supply_pose_x}"
                                        goal_y="{ally_supply_pose_y}"
                                        action_name="navigate_to_pose"/>
                            </RateController>

                            <!-- 点内微动，持续“接触/检测”补给区卡 -->
                            <RobotControl stop_gimbal_scan="False"
                                          chassis_spin_vel="0.2"/>
                        </ReactiveSequence>

                        <!-- 3) 抢控制区：对方每秒-1胜利点；离开后延迟2s失效 -->
                        <ReactiveSequence>
                            <RateController hz="1">
                                <!-- Converted from goal_pose to goal_x/goal_y -->
                                <SendGoal name="GoControlZone"
                                        goal_x="{control_zone_pose_x}"
                                        goal_y="{control_zone_pose_y}"
                                        action_name="navigate_to_pose"/>
                            </RateController>

                            <!-- 控制区内巡航/微动，避免点卡死区导致“以为站住了但读不到卡” -->
                            <RobotControl stop_gimbal_scan="False"
                                        chassis_spin_vel="0.5"/>
                        </ReactiveSequence>

                    </ReactiveFallback>

                </Fallback>
            </Fallback>
            <!-- 非比赛阶段停止云台和旋转，回家 -->
            <ReactiveSequence>
                    <RateController hz="1">
                    <!-- TODO: set goal_x and goal_y -->
                    <SendGoal name="Home"
                        goal_x="0.0"
                        goal_y="0.0"
                        action_name="navigate_to_pose"/>
                </RateController>
                <RobotControl stop_gimbal_scan="True"
                                chassis_spin_vel="0.0"/>
            </ReactiveSequence>
        </WhileDoElse>
        
    </BehaviorTree>
    <!-- Description of Node Models (used by Groot) -->
    <TreeNodesModel>
        <Action ID="GetCurrentLocation" editable="true">
            <output_port name="current_location" default="{current_location}"/>
        </Action>
        <Action ID="IsDetectEnemy" editable="true">
            <input_port name="message" default="{armors}"/>
        </Action>
        <Action ID="MoveAround" editable="true">
            <input_port name="expected_nearby_goal_count" default="5"/>
            <input_port name="expected_dis" default="0.3"/>
            <input_port name="message" default="{current_location}"/>
        </Action>
        <Action ID="Rotate" editable="true"/>
        <Action ID="ScanStatus" editable="true">
            <input_port name="scan_status" default="False"/>
        </Action>
        <Action ID="SendGoal" editable="true">
            <input_port name="goal_pose" default="{goal_pose}"/>
            <input_port name="goal_x" default="0.0"/>
            <input_port name="goal_y" default="0.0"/>
        </Action>
        <Action ID="SetGoal" editable="true">
            <input_port name="goal" default="0;0;0;0;0;0;1"/>
            <input_port name="message" default="{current_location}"/>
        </Action>
        <Action ID="SubAllRobotHP" editable="true">
            <input_port name="topic_name" default="robot_hp"/>
            <output_port name="robot_hp" default="{robot_hp}"/>
        </Action>
        <Action ID="SubArmors" editable="true">
            <input_port name="topic_name" default="/detector/armors"/>
            <output_port name="armors" default="{armors}"/>
        </Action>
        <Action ID="SubGameStatus" editable="true">
            <input_port name="topic_name" default="game_status"/>
            <output_port name="game_status" default="{game_status}"/>
            <output_port name="now_ms" default="{time.now_ms}"/>
        </Action>
        <Action ID="SubHP" editable="true">
            <input_port name="topic_name" default="sentry_hp"/>
            <output_port name="sentry_hp" default="{sentry_hp}"/>
        </Action>
        <Action ID="SubRobotStatus" editable="true">
            <input_port name="topic_name" default="robot_status"/>
            <output_port name="robot_status" default="{robot_status}"/>
        </Action>
        <Action ID="SelectBattleMode" editable="true">
            <input_port name="robot_status" default="{robot_status}"/>
            <output_port name="decision_num" default="{decision_num}"/>
        </Action>
        <Action ID="SubDecisionNum" editable="true">
            <input_port name="topic_name" default="decision_num"/>
            <output_port name="decision_num" default="{decision_num}"/>
        </Action>
        <Action ID="SubRFIDStatus" editable="true">
            <input_port  name="topic_name"/>
            <output_port name="rfid_status" default="{rfid.status}"/>
        </Action>
        <Action ID="InitBlackboardConfig" editable="true">
            <output_port name="heal_wait_ms" default="{cfg.heal_wait_ms}"/>
            <output_port name="heal_min_ratio" default="{cfg.heal_min_ratio}"/>
            <output_port name="search_timeout_ms" default="{cfg.search_timeout_ms}"/>
            <output_port name="recovery_timeout_ms" default="{cfg.recovery_timeout_ms}"/>
            <output_port name="supply_goal_x" default="{cfg.supply_goal_x}"/>
            <output_port name="supply_goal_y" default="{cfg.supply_goal_y}"/>
            <output_port name="arrive_radius" default="{cfg.arrive_radius}"/>
        </Action>
        <Action ID="SubRobotPosition" editable="true">
            <input_port name="topic_name" default="robot_position"/>
            <output_port name="pose_x" default="{pose_x}"/>
            <output_port name="pose_y" default="{pose_y}"/>
            <output_port name="pose_yaw" default="{pose_yaw}"/>
        </Action>
        <Action ID="RefSerialBlackboardSync" editable="true"/>
        <Action ID="StopMotion" editable="true"/>
        <Action ID="KeepRunning" editable="true"/>
        <Action ID="CancelNavGoal" editable="true">
            <input_port name="action_name" default="navigate_to_pose"/>
        </Action>
        <Action ID="UpdateWasDead" editable="true">
            <input_port  name="hp_cur" default="{hp.cur}"/>
            <inout_port  name="was_dead" default="{state.was_dead}"/>
        </Action>
        <Action ID="DetectRespawnAndSetRecovery" editable="true">
            <inout_port name="was_dead" default="{state.was_dead}"/>
            <input_port name="hp_cur" default="{hp.cur}"/>
            <input_port name="now_ms" default="{time.now_ms}"/>
            <inout_port name="need_recovery" default="{state.need_recovery}"/>
            <inout_port name="recovery_start_ms" default="{state.recovery_start_ms}"/>
            <inout_port name="search_start_ms" default="{state.search_start_ms}"/>
            <inout_port name="heal_start_ms" default="{state.heal_start_ms}"/>
        </Action>
        <Action ID="ClearRecoveryFlag" editable="true">
            <inout_port name="need_recovery" default="{state.need_recovery}"/>
            <inout_port name="heal_start_ms" default="{state.heal_start_ms}"/>
            <inout_port name="search_start_ms" default="{state.search_start_ms}"/>
            <inout_port name="recovery_start_ms" default="{state.recovery_start_ms}"/>
        </Action>
        <Action ID="SetNavGoalFromConfig" editable="true">
            <input_port  name="cfg_x" default="{cfg.supply_goal_x}"/>
            <input_port  name="cfg_y" default="{cfg.supply_goal_y}"/>
            <output_port name="goal_x" default="{nav.goal_x}"/>
            <output_port name="goal_y" default="{nav.goal_y}"/>
        </Action>
        <Action ID="InitSearchTimerIfNeeded" editable="true">
            <inout_port name="search_start_ms" default="{state.search_start_ms}"/>
        </Action>
        <Action ID="MicroSearchSupplyCard" editable="true">
            <inout_port name="search_start_ms" default="{state.search_start_ms}"/>
            <input_port name="timeout_ms" default="{cfg.search_timeout_ms}"/>
            <input_port name="rfid_supply_arrived" default="{rfid.supply_arrived}"/>
        </Action>
        <Action ID="WaitAndHeal" editable="true">
            <input_port name="now_ms" default="{time.now_ms}"/>
            <inout_port name="heal_start_ms" default="{state.heal_start_ms}"/>
            <input_port name="heal_wait_ms" default="{cfg.heal_wait_ms}"/>
            <input_port name="hp_cur" default="{hp.cur}"/>
            <input_port name="hp_max" default="{hp.max}"/>
            <input_port name="heal_min_ratio" default="{cfg.heal_min_ratio}"/>
        </Action>
        <Action ID="RecoveryTimeoutGuard" editable="true">
            <input_port name="now_ms" default="{time.now_ms}"/>
            <input_port name="recovery_start_ms" default="{state.recovery_start_ms}"/>
            <input_port name="timeout_ms" default="{cfg.recovery_timeout_ms}"/>
            <inout_port name="need_recovery" default="{state.need_recovery}"/>
        </Action>
        <Condition ID="IsAttaked" editable="true">
            <input_port name="message" default="{robot_status}"/>
        </Condition>
        <Condition ID="IsFriendOK" editable="true">
            <input_port name="message" default="{robot_hp}"/>
            <input_port name="friend_color" default="red"/>
        </Condition>
        <Condition ID="IsGameStart" editable="true">
            <input_port name="message" default="{game_status}"/>
        </Condition>
        <Condition ID="IsStatusOK" editable="true">
            <input_port name="message" default="{robot_status}"/>
            <input_port name="sentry_hp" default="{sentry_hp}"/>
            <input_port name="hp_threshold" default="200"/>
        </Condition>
        <Condition ID="IsHPAbove" editable="true">
            <input_port name="message" default="{robot_status}"/>
            <input_port name="hp_threshold" default="200"/>
        </Condition>
        <Condition ID="IsHPBelow" editable="true">
            <input_port name="message" default="{robot_status}"/>
            <input_port name="hp_threshold" default="100"/>
        </Condition>
        <Condition ID="IsModeRight" editable="true">
            <input_port name="decision_num" default="{decision_num}"/>
        </Condition>
        <Condition ID="IsModeLeft" editable="true">
            <input_port name="decision_num" default="{decision_num}"/>
        </Condition>
        <Condition ID="IsDead" editable="true">
            <input_port name="message" default="{robot_status}"/>
        </Condition>
        <Condition ID="IsRecoveryNeeded" editable="true">
            <input_port name="need_recovery" default="{state.need_recovery}"/>
        </Condition>
        <Condition ID="IsSupplyCardDetected" editable="true">
            <input_port name="rfid_status" default="{rfid.status}"/>
        </Condition>
        <Condition ID="IsWithinScope" editable="true">
            <input_port name="pose_x" default="{pose.x}"/>
            <input_port name="pose_y" default="{pose.y}"/>
            <input_port name="goal_x" default="{cfg.supply_goal_x}"/>
            <input_port name="goal_y" default="{cfg.supply_goal_y}"/>
            <input_port name="arrive_radius" default="{cfg.arrive_radius}"/>
        </Condition>
        <Condition ID="NotArrived" editable="true">
            <input_port name="arrived" default="{nav.arrived}"/>
        </Condition>
    </TreeNodesModel>
</root>
